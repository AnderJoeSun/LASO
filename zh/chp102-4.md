---
layout: post
title: 源码开放学ARM - Linux 内核模块 - 内核模块驱动代码实现
---

## 内核模块驱动代码实现

### write led.c
	
	#include <linux/module.h>
	#include <asm/io.h>
	
	MODULE_LICENSE("GPL");
	MODULE_AUTHOR("limingth");
	MODULE_DESCRIPTION("led module driver");
	MODULE_VERSION("version1.0");
	MODULE_ALIAS("myled test");
	
	static int * vmem;
	static int led_no = 0;
	module_param(led_no, int, 0);
	
	static __init int led_init(void)
	{
		printk("led init ok!\n");
	
	//	*(int *)0xe0200284 = 0x0;
		vmem = ioremap(0xe0200284, 4);
		printk("vmem = %p\n", vmem);
	//	*vmem = 0x0;
		*vmem &= ~(1 << led_no);
	
		return 0;
	}
	
	static __exit void led_exit(void)
	{
		printk("led exit ok!\n");
	
	//	*(int *)0xe0200284 = 0xf;
		*vmem = 0xf;
	
		return;
	}
	
	module_init(led_init);
	module_exit(led_exit);



### write a Makefile to compile
	
	obj-m := led.o
	
	KDIR := /home/akaedu/teacher_li/linux-2.6.35.7
	
	all:
		make modules -C $(KDIR) SUBDIRS=$(PWD)
	
	clean:
		-rm *.ko *.o *.order *.mod.c *.symvers

	第 1 行
	定义生成模块的名称。没有特殊约定时，hello.c 将会成为编译成 hello.c 的源代码文件。
	
	第 3 行
	指定内核源代码的位置
	
	第 4 行
	指定编译对象模块源代码所在位置的当前目录。
	
	第 7 行
	指定编译模块的命令。
	
	第 8 行
	利用编译结果清除所有的生成文件。
	
	编译后，会生成许多文件，2.6 内核中生成的模块实际名称为 hello.ko ， 也可以使用 hello.o 。

### compile and test it
	make 
	make V=1 (verbose)
	insmod led.ko led_no=3
	rmmod led
	 

[上一节](chp102-3.html)  |  [目录索引](../index.html)  |  [下一节](chp103-1.html)
