---
layout: post
title: 源码开放学ARM - Linux 网络设备驱动 - DM9000 驱动代码实现
---

## DM9000 驱动代码实现

## Linux 网卡驱动实验

### 标准Board Linux启动 & uBuntu Linux 连接
	1. pc linux	( 192.168.0.200 )
	2. board linux	( 192.168.0.201 )

	ifconfig 
	sudo ifconfig eth0 192.168.0.xxx

	测试网络连接 对ping可以连通

### uboot 启动 & uBuntu Linux 连接
	1. 开发板上的跳线 S2 拨到 SDBOOT 那边，通过 SD 卡启动
	2. 启动之后进入 uboot 选项
	3. [FriendlyLEG-TINY210]# printenv

	[FriendlyLEG-TINY210]# printenv
	baudrate=115200
	bootdelay=3
	ethact=dm9000
	ethaddr=00:01:02:03:04:05
	gatewayip=192.168.0.1
	ipaddr=192.168.0.201
	netmask=255.255.255.0
	serverip=192.168.0.200
	stderr=serial
	stdin=serial
	stdout=serial

	[FriendlyLEG-TINY210]# setenv ipaddr 192.168.0.201
	[FriendlyLEG-TINY210]# setenv serverip 192.168.0.200
	[FriendlyLEG-TINY210]# saveenv
	Saving Environment to NAND...
	Erasing Nand...
	Erasing at 0x40000 -- 100% complete.
	Writing to Nand... done
	[FriendlyLEG-TINY210]# 

	4. 重启开发板，验证是否设置成功？ 看到 is alive 表示成功
	[FriendlyLEG-TINY210]# ping 192.168.0.200 
	dm9000 i/o: 0x88001000, id: 0x90000a46 
	DM9000: running in 16 bit mode                                               
	MAC: 00:01:02:03:04:05                                                       
	operating at 100M full duplex mode                                           
	Using dm9000 device                                                          
	host 192.168.0.200 is alive                                                  
	[FriendlyLEG-TINY210]# 

### uboot 和 uBuntu 之间的 tftp 连接

#### ubuntu下搭建tftp server  
	
1. Install tftpd and related packages.  
	$ sudo apt-get install xinetd tftpd tftp

2. Create /etc/xinetd.d/tftp and put this entry:  
	service tftp
	{
		protocol        = udp
		port            = 69
		socket_type     = dgram
		wait            = yes
		user            = nobody
		server          = /usr/sbin/in.tftpd
		server_args     = /tftpboot
		disable         = no
	}

3. Make /tftpboot directory  
	$ sudo mkdir /tftpboot
	$ sudo chmod -R 777 /tftpboot
	$ sudo chown -R nobody /tftpboot

4. Start tftpd through xinetd  
	$ sudo /etc/init.d/xinetd restart
	
5. test tftp in localhost  
	$ cp something /tftpboot
	
	$ tftp localhost

	$ get something
	Received 4315348 bytes in 0.4 seconds

	$ tftp> quit
	$ ls something

6. test tftp in board	
	$ tftp 21000000 zImage
	
	
### uboot 和 uBuntu 之间的 uImage 内核下载测试

#### 设置 uboot 参数	
	# setenv bootargs root=/dev/mtdblock4 console=ttySAC0,115200 init=/linuxrc lcd=S70
	# printenv

#### 制作 uImage 内核文件
	# tftp 21000000 uImage
	# bootm 21000000
	
#### 获得 mkimage
	
### DM9000 驱动代码实现

#### 平台设备的注册
arch/arm/mach-s5pv210/mach-mini210.c 

#### 平台设备驱动的注册
drivers/net/dm9000.c

#### 头文件的包含
drivers/net/dm9000.h
include/linux/dm9000.h 

#### Makefile
	obj-m := dm9000.o
	
	
	KDIR := /home/limingth/tiny210/src/linux-2.6.35.7
	
	modules:
		make -C $(KDIR)	SUBDIRS=$(PWD)  $@
		ls -l dm9000.ko
	
	clean:
		-rm *.o *.ko
	
	i install:
		ls -l dm9000.ko
  
### step by step

* install tftpd  
	sudo apt-get install tftpd
	
* install inetd  
	sudo apt-get install openbsd-inetd
	
	server dir
		/srv/tftp
	
	sudo vi /etc/inetd.conf 
	
		#:BOOT: TFTP service is provided primarily for booting.  Most sites
		#       run this only on machines acting as "boot servers."
		#tftp		dgram	udp	wait	nobody	/usr/sbin/tcpd	/usr/sbin/in.tftpd /srv/tftp
		tftp		dgram	udp	wait	nobody	/usr/sbin/tcpd	/usr/sbin/in.tftpd /home/limingth/tiny210
	
	sudo /etc/init.d/openbsd-inetd restart

* download Image	
	limingth@ubuntu:~$ tftp 127.0.0.1
	tftp> get zImage2
	tftp> quit

* change u-boot bootargs
	
	root=/dev/mtdblock4 console=ttySAC0,115200 init=/linuxrc lcd=S70 
	
	setenv bootargs console=ttySAC0,115200
	
	[FriendlyLEG-TINY210]# setenv bootargs root=/dev/mtdblock4 console=ttySAC0,115200 init=/linuxrc lcd=S70 
	[FriendlyLEG-TINY210]# printenv
	baudrate=115200
	bootargs=root=/dev/mtdblock4 console=ttySAC0,115200 init=/linuxrc lcd=S70
	bootdelay=3
	ethact=dm9000
	ethaddr=08:0a:0a:0a:0a:0a
	gatewayip=192.168.0.1
	ip=192.168.0.201
	ipaddr=192.168.0.201
	netmask=255.255.255.0
	serverip=192.168.0.200
	stderr=serial
	stdin=serial
	stdout=serial
	
	Environment size: 315/16380 bytes

* 启动命令
	tftp 21000000 uImage
	bootm 21000000
	
#### 修改内核源码  
按以下方法修改内核以适应uboot，详参见liukun321的文章http://blog.csdn.net/liukun321/article/details/7383669，
忽略此步骤将会出现加载kernel时卡死在Uncompressing Linux... done, booting the kernel....

	arch/arm/mach-s5pv210/include/mach/memory.h 文件26,27行内容，  
	将Maximum of 256MiB in one bank的限制改为Maximum of 512MiB in one bank 作如下修改：
	
	#defineSECTION_SIZE_BITS   29
	
	#defineNODE_MEM_SIZE_BITS   29
	
#### 生成 uImage	
	limingth@ubuntu:~/tiny210/src$ ./mkimage 
	Usage: ./mkimage -l image
	          -l ==> list image header information
	       ./mkimage [-x] -A arch -O os -T type -C comp -a addr -e ep -n name -d data_file[:data_file...] image
	          -A ==> set architecture to 'arch'
	          -O ==> set operating system to 'os'
	          -T ==> set image type to 'type'
	          -C ==> set compression type 'comp'
	          -a ==> set load address to 'addr' (hex)
	          -e ==> set entry point to 'ep' (hex)
	          -n ==> set image name to 'name'
	          -d ==> use image data from 'datafile'
	          -x ==> set XIP (execute in place)
	       ./mkimage [-D dtc_options] -f fit-image.its fit-image
	       ./mkimage -V ==> print version information and exit
	limingth@ubuntu:~/tiny210/src$ ./mkimage -A arm -O linux -T kernel -C none -a 21000000 -e 21000040 -n "linux-2.6.28" -d zImage2  myuImage
	Image Name:   linux-2.6.28
	Created:      Wed Aug 29 13:32:34 2012
	Image Type:   ARM Linux Kernel Image (uncompressed)
	Data Size:    4288476 Bytes = 4187.96 kB = 4.09 MB
	Load Address: 21000000
	Entry Point:  21000040
	
/include/generated/mach-types.h  
./arch/arm/include/asm/mach-types.h

	limingth@ubuntu:~/tiny210/src/linux-2.6.35.7$ vi arch/arm/include/asm/mach-types.h 
	limingth@ubuntu:~/tiny210/src/linux-2.6.35.7$ vi include/generated/mach-types.h 
	
	in line 2950
		#define MACH_TYPE_MINI210              3466
	

[上一节](chp106-3.html)  |  [目录索引](../index.html)  |  [下一节](chp106-4.html)
