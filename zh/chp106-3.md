---
layout: post
title: 源码开放学ARM - Linux 网络设备驱动 - 网络设备驱动程序框架
---

## 网络设备驱动程序框架

### 网络设备驱动程序框架

• 上层协议发送数据包时
dev_queue_xmit(struct sk_buf *skb)

• 上层协议接受数据包时
int netif_rx(struct sk_buff *skb)

• struct sk_buff
套接字缓冲区，用于在linux网络子系统中各层之间传递数据，是linux网络子系统数据传输的中枢神经。
  
• struct sk_buff（linux/skbuff.h） 中的关键成员：

#### 各层协议头
A 传输层协议头：
	union {
		struct tcphdr *th;
		struct udphdr *uh;
		struct icmphdr *icmph;
		struct igmphdr *igmph;
		struct iphdr *ipiph;
		struct ipv6hdr *ipv6h;
		unsigned char *raw;//数据链路层头部
	} h;

B 网络层协议头
	union {
		struct iphdr *iph;
		struct ipv6hdr      *ipv6h;
		struct arphdr *arph;
		unsigned char     *raw;
	} nh;

C 链路层协议头
	union {
		unsigned char  *raw;
	} mac;


#### 数据缓存区指针：
	unsigned char *head：
	指向内存中已经分配的用于承载网络数据的缓冲 区起始地址，sk_buff和相关数据块在分配后该指针的值就被固定了。

	unsigned char *data：
	指向对应当前协议层有效数据的起始地址，每层协议有效数据含义不同。

	unsigned char *tail：
	指向当前协议层有效数据负载的结尾地址。

	unsigned char *end：
	指向分配的数据缓冲区的结尾，分配完即固定。

• 注意：网络报文在内存中不一定是联系存储的，同一网络报文有可能分成若干片存储在内存的不同位置：

长度信息
	unsigned int data_len: 
	记录在frags和frag_list中网络报文的长度。

	unsigend int len：
	记录网络报文的总长度。

	unsigned int truesize：
	记录head所指的存储区的大小。
	

#### 套接字缓冲区操作
1、分配：
	struct sk_buff *alloc_skb(unsigned int len,int priority);
	分配一个套接字缓冲区和一个数据缓冲区，len为数据缓冲区大小，16字节对齐。

	struct sk_buff *dev_alloc_skb(unsigned int)
	以GFP_ATOMIC方式调用上面接口，并保留head和data之间的16个字节。

2、释放
	void kfree_skb(struct sk_buff *skb)
	内核内部使用。

	void dev_kfree_skb(struct sk_buff *skb)
	驱动中使用，用于非中断上下文。

	void dev_kfree_skb_irq(kfree_skb(struct sk_buff *skb)
	驱动中使用，用于中断上下文。

	void dev_kfree_skb_any(kfree_skb(struct	sk_buff *skb)
	驱动中使用，中断和非中断上下文都可以。

#### 指针移动
A、put操作：
	将tail指针下移，增加sk_buff的len值，并返回skb->tail的当前值，用于在缓冲区尾部添加数据。
	unsigned char *skb_put(struct sk_buff *skb, unsigned int len) 

B、push操作
	将data指针上移，增加len的值，在存储空间的头部增加一段可以存储网络数据的空间，主要用于在数据包发送时添加头部。
	unsigned char *skb_push(struct sk_buff *skb, unsigned int len)

C、pull操作：
	将data指针下移，并减小skb的len的值，一般用于下层协议向上层协议移交数据包，使data指向上一层协议的协议头。
	unsigned char *skb_pull(struct sk_buff *skb, unsigned int len)

D、reserve操作：
	将data指针和tail指针同时下移，主要用于在存储空间的头部预留len长度的空隙。
	unsigned char *skb_reserve(struct sk_buff *skb, unsigned int len)

•UDP包接收上传至应用程序实例
数据链路层：dev_alloc_skb(),skb_pull()

网络层： skb_pull() 

传输层：

应用层：

调用recv()接收数据时，从skb->data+sizeof(struct udphdr)的位置开始复制数据到应用层缓冲区，由此可见UDP头部始终没有被剥离。

• 驱动需要实现的功能：
	1、网卡的初始化
	2、数据的发送
	3、数据的接收（中断）
	4、其它（流量控制，错误统计，超时处理）

[上一节](chp106-2.html)  |  [目录索引](../index.html)  |  [下一节](chp106-4.html)
